name: a11y storybook test

on:
  workflow_dispatch:

jobs:
  a11y-test:
    name: a11y test
    runs-on: ubuntu-latest
    steps:
      - name: set up base repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
      - name: set base env
        run: |
          echo "EXPECTED_KEY=$KEY" >> $GITHUB_ENV
        env:
          KEY: ${{ hashFiles('libs/**', 'package.json', 'packages/ui/**', 'packages/web/**', 'yarn.lock') }}
      - name: set up head repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - name: set head env
        run: |
          echo "ACTUAL_KEY=$KEY" >> $GITHUB_ENV
        env:
          KEY: ${{ hashFiles('libs/**', 'package.json', 'packages/ui/**', 'packages/web/**', 'yarn.lock') }}
      - name: Set up
        uses: ./.github/actions/setup-node
      - name: Set up playwright
        run: yarn playwright install
      - name: Run a11y test
        continue-on-error: true
        id: a11y_test
        run: |
          yarn web vrtest-setup
          yarn web vrtest-a11y
      - uses: 8398a7/action-slack@v3
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_CI }}
        with:
          status: ${{ job.status }}
          fields: repo,commit,ref,workflow,author,message
          custom_payload: |
            {
              attachments: [{
                color: '${{ job.status }}' === 'success' ? 'good' : '${{ job.status }}' === 'failure' ? 'danger' : 'warning',
                text: `cat ./packages/web/snapshot/a11y-comment.txt`,
              }]
            }
      - name: Upload a11y test report artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-test-report-artifact
          path: ./packages/web/snapshot/__report__
          retention-days: 1
